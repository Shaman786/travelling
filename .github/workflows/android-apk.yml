name: Android APK Build

on:
  push:
    branches:
      - main
      - feat/implement-react-native-video
  workflow_dispatch:
    inputs:
      profile:
        description: "Build Profile"
        required: true
        default: "preview" 
        type: choice
        options:
          - preview

jobs:
  build:
    runs-on: self-hosted
    env:
      ANDROID_HOME: /home/builder/build-station/toolchains/android-sdk
      ANDROID_SDK_ROOT: /home/builder/build-station/toolchains/android-sdk
      # CRITICAL: These are needed for the app to work!
      EXPO_PUBLIC_APPWRITE_ENDPOINT: ${{ secrets.EXPO_PUBLIC_APPWRITE_ENDPOINT }}
      EXPO_PUBLIC_APPWRITE_PROJECT_ID: ${{ secrets.EXPO_PUBLIC_APPWRITE_PROJECT_ID }}
      EXPO_PUBLIC_APPWRITE_PLATFORM: ${{ secrets.EXPO_PUBLIC_APPWRITE_PLATFORM }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm

      - name: Install dependencies
        run: npm install

      - name: Expo prebuild (Android)
        env:
          APP_VARIANT: preview
        run: npx expo prebuild --platform android --clean

      - name: Configure Android SDK
        run: |
          echo "Using ANDROID_HOME=$ANDROID_HOME"
          echo "sdk.dir=$ANDROID_HOME" > android/local.properties
          chmod +x android/gradlew

      - name: Build APK (Debug)
        env:
          SENTRY_AUTH_TOKEN: ${{ secrets.SENTRY_AUTH_TOKEN }}
        run: |
          cd android
          # We use assembleDebug to avoid keystore/signing errors
          ./gradlew assembleDebug --no-daemon

      - name: Upload to transfer.sh & Send Link
        run: |
          STAMP=$(date +%Y%m%d-%H%M)
          APK_NAME=travelling-debug-$STAMP.apk
          
          # Rename the file
          mv android/app/build/outputs/apk/debug/app-debug.apk $APK_NAME
          
          echo "Uploading $APK_NAME to transfer.sh..."
          
          # Upload using curl and save the URL
          # transfer.sh returns the URL as the response body
          DOWNLOAD_URL=$(curl --upload-file ./$APK_NAME https://transfer.sh/$APK_NAME)
          
          echo "Link: $DOWNLOAD_URL"
          
          # Send the LINK to Telegram (instead of the file)
          curl -s -X POST https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage \
              -d chat_id=${{ secrets.TELEGRAM_CHAT_ID }} \
              -d text="ðŸš€ *Build Complete!* %0AðŸ“¦ File: $APK_NAME %0AðŸ”— Download: $DOWNLOAD_URL" \
              -d parse_mode="Markdown"

      - name: Cleanup
        if: always()
        run: |
          rm -rf android/
          rm -rf node_modules/