name: Android APK Build (R2)

on:
  push:
    branches:
      - main
      - feat/implement-react-native-video
  workflow_dispatch:
    inputs:
      profile:
        description: "Build Profile"
        required: true
        default: "preview" 
        type: choice
        options:
          - preview

jobs:
  build:
    runs-on: self-hosted
    env:
      ANDROID_HOME: /home/builder/build-station/toolchains/android-sdk
      ANDROID_SDK_ROOT: /home/builder/build-station/toolchains/android-sdk
      # Appwrite Secrets
      EXPO_PUBLIC_APPWRITE_ENDPOINT: ${{ secrets.EXPO_PUBLIC_APPWRITE_ENDPOINT }}
      EXPO_PUBLIC_APPWRITE_PROJECT_ID: ${{ secrets.EXPO_PUBLIC_APPWRITE_PROJECT_ID }}
      EXPO_PUBLIC_APPWRITE_PLATFORM: ${{ secrets.EXPO_PUBLIC_APPWRITE_PLATFORM }}
      
      # Mapbox Token (Required for Build)
      RNMAPBOX_MAPS_DOWNLOAD_TOKEN: ${{ secrets.RNMAPBOX_MAPS_DOWNLOAD_TOKEN }}

      # ‚úÖ FIX 1: Put the Public Domain Here
      DOWNLOAD_DOMAIN: "https://pub-1d4d217c0080414481b5a0f03becdb89.r2.dev"

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm

      - name: Install dependencies
        run: npm install

      - name: Expo prebuild (Android)
        env:
          APP_VARIANT: preview
        run: npx expo prebuild --platform android --clean

      - name: Configure Android SDK
        run: |
          echo "sdk.dir=$ANDROID_HOME" > android/local.properties
          chmod +x android/gradlew

      - name: Configure Release to use Debug Keystore (Hack)
        run: |
          # Replace signingConfig signingConfigs.release with signingConfigs.debug in build.gradle
          # This forces 'release' build type to use the 'debug' key
          sed -i 's/signingConfig signingConfigs.release/signingConfig signingConfigs.debug/g' android/app/build.gradle || true
          # Also ensure it is using debug config if release config is not strictly defined yet
          # For Expo projects, usually release block exists.
          
      - name: Build APK (Release)
        run: |
          cd android
          ./gradlew assembleRelease --no-daemon

      - name: Upload APK to R2 & Notify Telegram
        run: |
          STAMP=$(date +%Y%m%d-%H%M)
          APK_NAME=travelling-release-$STAMP.apk
          
          # 1. Move to Artifacts Folder
          mkdir -p ~/build-station/artifacts
          mv android/app/build/outputs/apk/release/app-release.apk ~/build-station/artifacts/$APK_NAME
          
          echo "üöÄ Uploading $APK_NAME to R2..."
          
          # 2. Call your Server Script (puts it in 'travelling' folder)
          ~/build-station/scripts/upload_artifact.sh \
              ~/build-station/artifacts/$APK_NAME \
              "travelling"
          
          # 3. Construct Download Link
          # ‚úÖ FIX 2: Combine Domain + Folder + Filename
          DOWNLOAD_URL="${{ env.DOWNLOAD_DOMAIN }}/travelling/$APK_NAME"
          
          echo "Link: $DOWNLOAD_URL"
          
          # 4. Send Link to Telegram
          curl -s -X POST https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage \
              -d chat_id=${{ secrets.TELEGRAM_CHAT_ID }} \
              -d text="üöÄ *Build Complete!* %0Aüì¶ File: $APK_NAME %0A‚òÅÔ∏è Stored in: R2/travelling %0Aüîó Download: $DOWNLOAD_URL" \
              -d parse_mode="Markdown"

      - name: Cleanup
        if: always()
        run: |
          rm -rf android/
          rm -rf node_modules/