name: Android APK Build

on:
  push:
    branches:
      - main
      - feat/implement-react-native-video
  workflow_dispatch:
    inputs:
      profile:
        description: "Build Profile"
        required: true
        default: "preview" 
        type: choice
        options:
          - preview

jobs:
  build:
    runs-on: self-hosted
    env:
      ANDROID_HOME: /home/builder/build-station/toolchains/android-sdk
      ANDROID_SDK_ROOT: /home/builder/build-station/toolchains/android-sdk
      # CRITICAL: These are needed for the app to work!
      EXPO_PUBLIC_APPWRITE_ENDPOINT: ${{ secrets.EXPO_PUBLIC_APPWRITE_ENDPOINT }}
      EXPO_PUBLIC_APPWRITE_PROJECT_ID: ${{ secrets.EXPO_PUBLIC_APPWRITE_PROJECT_ID }}
      EXPO_PUBLIC_APPWRITE_PLATFORM: ${{ secrets.EXPO_PUBLIC_APPWRITE_PLATFORM }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm

      - name: Install dependencies
        run: npm install

      - name: Expo prebuild (Android)
        env:
          APP_VARIANT: preview
        run: npx expo prebuild --platform android --clean

      - name: Configure Android SDK
        run: |
          echo "Using ANDROID_HOME=$ANDROID_HOME"
          echo "sdk.dir=$ANDROID_HOME" > android/local.properties
          chmod +x android/gradlew

      - name: Build APK (Debug)
        env:
          SENTRY_AUTH_TOKEN: ${{ secrets.SENTRY_AUTH_TOKEN }}
        run: |
          cd android
          # We use assembleDebug to avoid keystore/signing errors
          ./gradlew assembleDebug --no-daemon

      - name: Send APK to Telegram
        run: |
          # 1. Identify the APK file
          STAMP=$(date +%Y%m%d-%H%M)
          APK_NAME=travelling-debug-$STAMP.apk

          # 2. Rename the standard debug output
          # Note: Debug output location is slightly different than release
          mv android/app/build/outputs/apk/debug/app-debug.apk $APK_NAME

          # 3. Send to Telegram
          echo "Sending $APK_NAME to Telegram..."
          curl -v -F "chat_id=${{ secrets.TELEGRAM_CHAT_ID }}" \
               -F document=@$APK_NAME \
               -F caption="ðŸš€ Build Complete: $APK_NAME" \
               https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendDocument

      - name: Cleanup
        if: always()
        run: |
          rm -rf android/
          rm -rf node_modules/